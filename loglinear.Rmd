---
title: "loglinear"
author: "Dong Luo"
date: "22 October 2018"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

## Data Cleaning

We exclude the obervations with age less than 18 since our research questions only focus on adult.

```{r import_data, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(kableExtra)
#setwd("~/GitHub/STAT3014-Major-Project")
#library(ggplot2)
Data <- read.csv("C:/Users/luodo/Documents/GitHub/STAT3014-Major-Project/cleanedData.csv")
#dim(Data)
adultData<-Data[Data$AGEC>=18,]
```

##  

We cut each of the continuous variables `CHOPER1`, `FATPER1`, and `PROPER1`, which stannd for the percentage of energy comes from carbohydrate, fat,and protein, into three distinct levels, from low, medium, to high.

|        | Carbohydrate | Fat      | Protein  |
|--------|--------------|----------|----------|
| low(%)    | [0,45]       | [0,20]   | [0,15]   |
| medium(%) | (45,65]      | (20,35]  | (15,25]  |
| high(%)   | (65,100]     | (35,100] | (25,100] |

```{r cut,echo=FALSE}
carb.cat<-cut(adultData$CHOPER1,
              breaks=c(-1,45,65,100),
              labels=c('low','medium','high'))
fat.cat<-cut(adultData$FATPER1,
             breaks=c(-1,20,35,100),
             labels=c('low','medium','high'))
protein.cat<-cut(adultData$PROPER1,
                 breaks=c(-1,15,25,100),
                 labels=c('low','medium','high'))
```

By dividing we are interested in the mean proportion of each diet types, so as to identify what are the most popular diet types.

```{r echo=FALSE}
tables.3way<-table(carb.cat,fat.cat,protein.cat)
table.y<-NULL
for(i in 1:3){
  for(j in 1:3){
    table.y<-c(table.y,tables.3way[j,,i])
  }
}
table.fat<-factor(rep(c('low','medium','high'),9))
table.carb<-factor(rep(c('low','medium','high'),each=3,times=3))
table.protein<-factor(rep(c('low','medium','high'),each=9))
loglin.dat<-data.frame(y=table.y,
                          fat=table.fat,
                          carb=table.carb,
                          protein=table.protein)
diet.prop<-cbind(loglin.dat[,1]/nrow(adultData),
  loglin.dat[,2:4])
colnames(diet.prop)[1]<-'proportion'

# sort the df by proportion
diet.prop<-diet.prop[order(
  diet.prop$proportion,decreasing=TRUE),]

# see most common diet types in our sample
kable_styling(kable(
  head(diet.prop),
  row.names = F,
  booktabs=TRUE,
  caption = "Proportion of the top 6 diet types"
  ),
  latex_options = 'hold_position',
  position = "center")
```

We may be interested to fit log-linear models to analyse this three-way contingency tables to see if there is any independence underlying.  

### Structural Zeroes
Noticing that there are some cells with value zero in our table. We would treat the zeroes as structural zeroes (impossible combinations), since the variables `CHOPER1` (carbohydrate), `FATPER1` (fat), and `PROPER1` (protein) in the original dataset stand for the proportions, which means some diet types listed in the table such as (high carbohydrate, high fat,high protein) is not possible since the sum of the values of the three variables would exceed 100. We will remove the cells of structural zeroes from the and model the incomplete table. 
```{r removing_zeroes, echo=FALSE}
loglin.dat<-loglin.dat[loglin.dat$y>0,]
```

There are 20 out of 27 cells with positive entries. The null model will have 20-1=19 degrees of freedom and the additive model will have 13 degrees of freedom.
We start with the addtivie model, which stands for the complete independence.

```{r additive, echo=FALSE, warning=FALSE}
glm.additive<-glm(y~carb+fat+protein,
                family='poisson',data=loglin.dat)
#glm.additive$dev
```

We found that the deviance for the additive model (including all three factors) is `r glm.additive$dev`. We compare it with the models with one two way interaction. There are three such models, and their residual deviance is shown as below.

```{r echo=FALSE}
# additive model is for complete independence
glm.cf<-glm(y~carb+fat+protein+carb:fat,
                family='poisson',data=loglin.dat)
glm.cp<-glm(y~carb+fat+protein+carb:protein,
          family='poisson',data=loglin.dat)
glm.fp<-glm(y~carb+fat+protein+fat:protein,
          family='poisson',data=loglin.dat)
#c(glm.cf$dev,glm.cp$dev,glm.fp$dev)
dev1.table<-data.frame('Carb:Fat'=glm.cf$dev,
           'Carb:Protein'=glm.cp$dev,
           'Fat:Protein'=glm.fp$dev)
rownames(dev1.table)<-c('Residual Deviance')
kable_styling(kable(
  dev1.table,
  row.names = F,
  format='latex',
  booktabs=TRUE),position = "center")
```

The model with `carb:fat` interaction has the lowest deviance. The difference of deviance between this model and the additive model is `r glm.additive$dev-glm.cf$dev`. The two models are nested and when we compare them, the $H_0$ is the additive model (the smaller model).

$$
\text{M1}\,(H_0):
\hat{\mu}=\beta_0+\alpha_i+\beta_j+\gamma_k,
$$

where $\alpha_i$, $\beta_j$, and $\gamma_k$ denote the $i^{th},j^{th}$ and $k^{th}$ group of carbohydrate, fat, and protein levels
$$
\text{M2}\,(H_A): \hat{\mu}=\beta_0+\alpha_i+\beta_j+\gamma_k+(\alpha\beta)_{ij}
$$
Under $H_0$, the difference in deviance follows a $\chi^2$ distribution whose degrees of freedom equals the difference in residual degrees of freedom of the two models. 
If our table was complete, we would expect the difference in degress of freedom to be $(3-1)\times(3-1)=4$, since each factor has 3 levels.   
Here the difference in degrees of freedom is 3, this is because there was a structural zero in the marginal table of carbohydrate and fat (we cannot have high carbohydrate and high fat at the same time), so we are only adding three parameters when fitting the model. An coefficient of an interaction level in the `glm` function output will be `NA`.   
The $p$-value for the test is close to 0, so we would reject the null hypothesis and prefer the model with `carb:fat` interaction. This model with one interaction term stands for the block independence.   
We use the same procedure to test the models with more interaction terms, and the result of the test is summarised in the following table.

```{r more_interactions, message=FALSE, warning=FALSE, include=FALSE}
# reject the additive model(complete independence)
glm.cf.cp<-glm(y~carb+fat+protein+carb:fat+carb:protein,
                family='poisson',data=loglin.dat)
glm.cf.fp<-glm(y~carb+fat+protein+carb:fat+fat:protein,
                family='poisson',data=loglin.dat)
glm.cp.fp<-glm(y~carb+fat+protein+carb:protein+fat:protein,
                family='poisson',data=loglin.dat)
c(glm.cf.cp$dev,glm.cf.fp$dev)
c(glm.cf.cp$df.residual,glm.cf.fp$df.residual)
#
1-pchisq(glm.cf$dev-glm.cf.cp$dev,
glm.cf$df.residual-glm.cf.cp$df.residual)
anova(glm.cf.cp,test="Chisq")
# reject null and prefer glm.cf.cp

# test the uniform association case
glm.u.a<-glm(y~carb+fat+protein+carb:fat+carb:protein+fat:protein,
                family='poisson',data=loglin.dat)
glm.u.a$dev
1-pchisq(glm.cf.cp$dev-glm.u.a$dev,
glm.cf.cp$df.residual-glm.u.a$df.residual)

# test the saturated model
glm.sat<-glm(y~carb*fat*protein,
                family='poisson',data=loglin.dat)
1-pchisq(glm.u.a$dev-glm.sat$dev,
glm.u.a$df.residual-glm.sat$df.residual)
anova(glm.sat,test="Chisq")
```


```{r deviance_table, echo=FALSE, message=FALSE, warning=FALSE}
# make the deviance table
# library(dplyr)
deviances<-round(c(
  glm.additive$dev,
  c(glm.cf$dev,glm.cp$dev,glm.fp$dev),
  c(glm.cf.cp$dev,glm.cf.fp$dev,glm.cp.fp$dev),
  c(glm.u.a$dev,glm.sat$dev)
  ),0)
dfs<-round(c(
  glm.additive$df.residual,
  c(glm.cf$df.residual,glm.cp$df.residual,glm.fp$df.residual),
  c(glm.cf.cp$df.residual,glm.cf.fp$df.residual,glm.cp.fp$df.residual),
  c(glm.u.a$df.residual,glm.sat$df.residual)
  ),0)
collapse_rows_dt <- data.frame(Type = c('Completely Independence Model',
                                        rep('Block Independence Model',3),
                                        rep('Conditional Independence Model',3),
                                        'Uniform Association Model',
                                        'Saturated Model'),
                 Model = c('C+F+P', 'P+CF', 'F+CP', 'C+FP',
                           'CF+CP','CF+FP','CP+FP',
                           'CF+CP+FP','CFP'),
                 Deviance = deviances,
                 d.f. = dfs)
# kable(collapse_rows_dt, align = "c") %>%
#   kable_styling(full_width = F) %>%
#   column_spec(1, bold = T) %>%
#   collapse_rows(columns = 1:2, valign = "top") %>%
#   kable_styling(latex_options = 'hold_position',
#                 position = "center")
# collapse_rows_dt <- data.frame(C1 = c(rep("a", 10), rep("b", 5)),
#                  C2 = c(rep("c", 7), rep("d", 3), rep("c", 2), rep("d", 3)),
#                  C3 = 1:15,
#                  C4 = sample(c(0,1), 15, replace = TRUE))
collapse_rows_dt %>%
kable("latex", booktabs = T, escape = F,
caption = "Deviances for Poisson log-linear models") %>%
kable_styling(full_width = F) %>%
column_spec(1, bold = T) %>%
collapse_rows(columns = 1, valign = "middle") %>%
kable_styling(latex_options = 'hold_position',
              position = "center")
```

## limitations
Poisson distribution assumption,
sampling zeroes.
